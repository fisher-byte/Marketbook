# MarketBook 开发计划：让项目真正能用

> 目标：前后端完整打通，注册、登录、模拟盘可实际运行。

---

## 一、目标拆解

### 核心目标

1. **注册**：用户填写表单 → 提交 → 数据持久化 → 返回成功
2. **登录**：用户填写表单 → 校验 → 返回 JWT → 前端保存并跳转
3. **认证态**：登录后可访问个人资料、模拟盘等受保护页面
4. **模拟盘**：创建账户、下单、查看持仓（前后端打通）

### 非本阶段目标

- 论坛（暂不开发）
- 策略分析、社区等
- 生产级部署、HTTPS、邮箱验证等

---

## 二、当前问题清单

| 问题 | 位置 | 影响 |
|------|------|------|
| 无数据存储 | User/UserProfile 为纯类，无 findOne/save | authService 调用会报错 |
| auth 方法名不匹配 | auth 路由用 registerUser，AuthService 只有 register | 路由调用失败 |
| 验证中间件缺失 | validation 未导出 validateRegistration/validateLogin | 路由加载即报错 |
| 路由未挂载 | app.js 未挂载 src/routes | API 不可用 |
| 前端未接 API | 登录/注册表单未调用后端 | 提交无效果 |

---

## 三、实施计划

### 阶段 1：数据层（约 1 天）

**1.1 内存存储**

- 新增 `src/db/memoryStore.js`：内存 Map 存储 User、UserProfile
- 提供 `findOne`、`save`、`findById` 等接口

**1.2 存储适配层**

- 新增 `src/models/UserStore.js`：对 User/UserProfile 做薄封装，调用内存存储
- authService 改用 UserStore，不再依赖 Mongoose

**验收**：`UserStore.findOne({email})`、`UserStore.save(user)` 可正常读写

---

### 阶段 2：修复认证链路（约 0.5 天）

**2.1 验证中间件**

- 在 `validation.js` 中补充导出：
  - `validateRegistration = [...registerValidation, handleValidationErrors]`
  - `validateLogin = [...loginValidation, handleValidationErrors]`
- 注册接口去掉 `confirmPassword` 必填（或前端补齐）

**2.2 authService 与路由对齐**

- 在 authService 中增加 `registerUser`、`loginUser`、`getCurrentUser`、`revokeToken` 等包装方法，内部调用 `register`、`login` 等

**2.3 路由与 app 挂载**

- app.js 挂载 `/api`  prefix，引入 `src/routes/index.js`
- 确保 `/api/auth/register`、`/api/auth/login` 可访问

**验收**：`curl -X POST /api/auth/register -d '...'` 返回成功；`/api/auth/login` 返回 token

---

### 阶段 3：前端对接（约 1 天）

**3.1 登录页**

- 表单提交调用 `POST /api/auth/login`
- 成功：将 token 存入 localStorage，跳转首页或个人中心
- 失败：展示错误信息

**3.2 注册页**

- 表单提交调用 `POST /api/auth/register`
- 成功：可选自动登录或跳转登录页
- 失败：展示错误信息

**3.3 鉴权与跳转**

- 需要登录的页面：检查 localStorage 中的 token
- 无 token：跳转登录页
- 有 token：请求头带上 `Authorization: Bearer <token>` 调用接口

**验收**：在浏览器完成注册 → 登录 → 进入个人资料页

---

### 阶段 4：模拟盘打通（约 1–2 天）

**4.1 后端**

- 确认 trading 路由可在无真实 DB 时运行（用内存或现有 TradingEngine）
- 挂载 trading 路由，auth 中间件校验 token

**4.2 前端**

- 模拟盘入口页：创建账户、下单表单
- 调用 `/api/trading/accounts`、`/api/trading/orders/buy` 等
- 展示持仓、盈亏

**验收**：登录后可在模拟盘创建账户、下单、查看持仓

---

## 四、任务清单（可勾选）

### 阶段 1 数据层

- [ ] 创建 `src/db/memoryStore.js`
- [ ] 创建 `src/models/UserStore.js`（或 UserMongoose 替代）
- [ ] 修改 authService 使用 UserStore

### 阶段 2 认证

- [ ] 补充 validation.js 导出 validateRegistration、validateLogin
- [ ] authService 增加 registerUser、loginUser 等包装
- [ ] app.js 挂载 /api 路由

### 阶段 3 前端

- [ ] 登录页对接 /api/auth/login
- [ ] 注册页对接 /api/auth/register
- [ ] 个人资料页加 token 校验与请求头

### 阶段 4 模拟盘

- [ ] 确认 trading 路由可运行
- [ ] 模拟盘页面对接 API
- [ ] 展示持仓与盈亏

---

## 五、技术选型说明

### 为何先用内存存储？

- 无需安装 MongoDB，`npm start` 即可跑
- 快速验证前后端流程
- 之后可替换为 Mongoose + MongoDB，接口形态不变

### 后续升级

- 将 `memoryStore` 替换为 Mongoose 模型
- 配置 MongoDB 连接
- 无需改动路由与前端调用
